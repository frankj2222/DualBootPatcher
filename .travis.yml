sudo: required

services:
  - docker

before_install:
  # Clone DualBootPatcher Repository
  - git clone --recursive https://github.com/frankj2222/DualBootPatcher -b master DualBootPatcher/
  # Pull docker images
  - docker pull yshalsager/dualbootpatcher:9.3.0-7-base
  - docker pull yshalsager/dualbootpatcher:9.3.0-7-android
  - docker pull yshalsager/dualbootpatcher:9.3.0-7-linux
script:
  # Make work directories 
  - mkdir $HOME/.android
  - mkdir -p ${TRAVIS_BUILD_DIR}/DualBootPatcher/builder/ && cd ${TRAVIS_BUILD_DIR}/DualBootPatcher/
  # Build APK
  - |
    docker run --rm -i -e USER_ID=$(id -u) -e GROUP_ID=$(id -g) -v "$(pwd):/builder/DualBootPatcher:rw,z" -v "${HOME}/.android:/builder/.android:rw,z" yshalsager/dualbootpatcher:9.3.0-7-android bash << EOF
    cd DualBootPatcher/builder && cmake .. -DMBP_BUILD_TARGET=android -DMBP_BUILD_TYPE=debug && make -j16 && rm -rf assets && cpack && make apk -j16
    make android-system_armeabi-v7a -j16 && make -C data/devices -j16
    exit
    EOF
  - |
    docker run --rm -i -e USER_ID=$(id -u) -e GROUP_ID=$(id -g) -v "$(pwd):/builder/DualBootPatcher:rw,z" -v "${HOME}/.android:/builder/.android:rw,z" yshalsager/dualbootpatcher:9.3.0-7-linux bash << EOF
    # Build Utilities Zip
    cd ~/DualBootPatcher/builder && ./utilities/create.sh
    # Build Linux
    cmake .. -DMBP_BUILD_TARGET=desktop -DMBP_PORTABLE=ON && make -j16 && cpack
    exit
    EOF
after_success:
  
deploy:
  provider: releases
  api_key:
    secure: HdHjUAHbDIcXAIvmBhJU0OTrBpGn7fy6aPkLHF/X99qkuUvDYMM+OPyj//R3elX04pnWIHSs4r3ffGGwj+EJ5mnvkqJYVW2Svi7MJZJLCooYCCJ5r7HjhLq0EtdmU4Ea1ieNuH6niM9RYqKsv+/1d+Hxjw9JfJ6asfqCqXTJiTETEKO2//QDXMw8iRag0XG1Be52/hGhfBVbvgvaOlxTCxjycnC9X1zru+CiFf0qe2BK/xfA8QxZ6J3lHLr8W4/LsMg2450vLfljyqO8clPzH95qAkuKfZPj/+MkLeyIGWUfUHSzY/NkbRJxmpmCqRDQVBNXTAjVwSBr28XqevjL1W45rMjog5DbObYEv4BIocRjeNQ7saVwC0l7ox+KwClcTlMcJTwGVoHJj1ueWIfL0i8aoGMymyAxDfe3ccT/cLdmRvfP1xFczENSjSt76px/rS52D40mZ3vf6GZUtCWOrVtOiX+Cjsoq8FiJ02sIT46QPcsORgVxo24UcLtirdXV5Ok6zg/O3yJYFPFkmX55S8aSoDR4qt3ZGxsxXdUAm4pjuuqDZ1KDEYWD2zcb6NXQ+YcRb8TxWUuMr2sPVl1kOteUgjZmmLCsOYdyTcp8YyanySo3C4jj4TDbJ3N5W1amsIlQ56+hLsR1YYPMY0NpZtTzdJgbUCn/bC3AnvF7q/s=
  file: DualBootUtilities-9.3.0.zip
  file: DualBootPatcher-9.3.0-Linux.zip
  file: Android_GUI-debug.apk
on:
  repo: frankj2222/DualBootPatcher
